import tensorflow as tf
from tensorflow.keras import layers, models
from tensorflow.keras.applications import MobileNetV2
import os

# === CONFIG ===
IMG_SIZE = (128, 128)
BATCH_SIZE = 32

# === PATH SETUP ===
base_wave = r"C:\Users\Hooria\OneDrive - YMCAs in Canada\Desktop\archive (1)\drawings\wave"
base_spiral = r"C:\Users\Hooria\OneDrive - YMCAs in Canada\Desktop\archive (1)\drawings\spiral"

train_dirs = [os.path.join(base_wave, "training"),
              os.path.join(base_spiral, "training")]

test_dirs = [os.path.join(base_wave, "testing"),
             os.path.join(base_spiral, "testing")]

# === LOAD & COMBINE TRAINING DATA ===
train_ds1 = tf.keras.preprocessing.image_dataset_from_directory(
    train_dirs[0],
    image_size=IMG_SIZE,
    batch_size=BATCH_SIZE,
    label_mode='int',
    shuffle=True
)
train_ds2 = tf.keras.preprocessing.image_dataset_from_directory(
    train_dirs[1],
    image_size=IMG_SIZE,
    batch_size=BATCH_SIZE,
    label_mode='int',
    shuffle=True
)

# ✅ Save class names before concatenation
class_names = train_ds1.class_names
print("Class names:", class_names)

# ✅ Combine & shuffle
train_ds = train_ds1.concatenate(train_ds2)
train_ds = train_ds.shuffle(100, reshuffle_each_iteration=True)

# === LOAD & COMBINE TESTING DATA ===
test_ds1 = tf.keras.preprocessing.image_dataset_from_directory(
    test_dirs[0],
    image_size=IMG_SIZE,
    batch_size=BATCH_SIZE,
    label_mode='int',
    shuffle=False
)
test_ds2 = tf.keras.preprocessing.image_dataset_from_directory(
    test_dirs[1],
    image_size=IMG_SIZE,
    batch_size=BATCH_SIZE,
    label_mode='int',
    shuffle=False
)
test_ds = test_ds1.concatenate(test_ds2)

# === DATA AUGMENTATION ===
data_augmentation = tf.keras.Sequential([
    layers.RandomFlip("horizontal"),
    layers.RandomRotation(0.1),
    layers.RandomZoom(0.1),
])

# === BUILD MODEL ===
base_model = MobileNetV2(input_shape=IMG_SIZE + (3,),
                         include_top=False,
                         weights='imagenet')
base_model.trainable = False  # Freeze base model

model = models.Sequential([
    data_augmentation,
    layers.Rescaling(1./255),
    base_model,
    layers.GlobalAveragePooling2D(),
    layers.Dense(128, activation='relu'),
    layers.Dropout(0.5),
    layers.Dense(2)  # 2 output classes: healthy, parkinson
])

model.compile(optimizer='adam',
              loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True),
              metrics=['accuracy'])

# === TRAIN MODEL ===
history = model.fit(train_ds, validation_data=test_ds, epochs=10)

# === EVALUATE ===
test_loss, test_acc = model.evaluate(test_ds)
print(f"\n✅ Combined Test Accuracy: {test_acc:.2f}")
